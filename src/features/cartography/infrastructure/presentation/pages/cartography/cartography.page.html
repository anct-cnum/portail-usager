<div class="fr-display--flex fr-flex-direction--column fr-full-container--height">
  <div class="fr-grid-row fr-flex-wrap--nowrap fr-overflow--hidden fr-full-container--height">
    <div
      [ngClass]="{
      'fr-col-xl-8 fr-col-lg-7': displayDetailsStructureId,
      'fr-col-xl-4 fr-col-lg-5': !displayDetailsStructureId,
      'fr-displayed-lg': displayMap,
      'fr-col-12': !displayMap
      }"
      class="fr-display--flex fr-flex-direction--column fr-index--over fr-shadow--right fr-full-container--width">
      <cnfs-details
        class="fr-full-container--height"
        *ngIf="cnfsDetails$ | async as cnfsDetails; else: displayCnfsList"
        [address]="cnfsDetails.address"
        [cnfsList]="cnfsDetails.cnfsList"
        [distance]="cnfsDetails.distanceFromUsager"
        [email]="cnfsDetails.email"
        [cnfsTypeNote]="cnfsDetails.cnfsTypeNote"
        [opening]="cnfsDetails.opening"
        [phone]="cnfsDetails.phone"
        [structureName]="cnfsDetails.structureName"
        [website]="cnfsDetails.website"
        (print)="printCnfsDetails()"
        (backToList)="hideCnfsDetails()"></cnfs-details>
      <ng-template #displayCnfsList>
        <address-geolocation
          [addressSuggestions]="(addressesFound$ | async) ?? []"
          [geocodeAddressError]="(geocodeAddressError$ | async) ?? false"
          (usagerAutolocate)="onAutoLocateUsagerRequest($event)"
          (addressToGeocode)="onGeocodeUsagerRequest($event)"
          (searchAddress)="onSearchAddress($event)"></address-geolocation>
        <ng-container *ngIf="structuresList$ | async as structuresList">
          <small class="fr-px-3w fr-background-contrast--blue-cumulus" *ngIf="structuresList.length > 0">
            {{ structuresList.length }} structures trouvÃ©es
          </small>
          <cnfs-list
            class="fr-px-3w fr-overflow--auto"
            [structuresList]="structuresList"
            [highlightedStructureId]="highlightedStructureId$ | async"
            (displayDetails)="displayCnfsDetails($event)"></cnfs-list>
        </ng-container>
      </ng-template>
    </div>
    <div
      *ngIf="centerView$ | async as centerView"
      [ngClass]="displayDetailsStructureId ? 'fr-col-xl-4 fr-col-lg-5' : 'fr-col-xl-8 fr-col-lg-7'"
      class="fr-col-12">
      <permanence-map
        [centerView]="centerView"
        [cnfsRegionMarkers]="regionMarkers$ | async"
        [cnfsDepartementMarkers]="departementMarkers$ | async"
        [cnfsPermanenceMarkers]="permanenceMarkers$ | async"
        [usagerMarker]="usagerMarker$ | async"
        [highlightedStructureId]="highlightedStructureId$ | async"
        (cnfsRegionMarkerChange)="onCnfsLocalityMarkerChange($event)"
        (cnfsDepartementMarkerChange)="onCnfsLocalityMarkerChange($event)"
        (cnfsPermanenceMarkerChange)="onCnfsPermanenceMarkerChange($event)"
        (displayDetails)="displayCnfsDetails($event); switchMapList.toggle()"
        (stateChange)="onMapViewChanged($event)"
        (zoomOut)="onZoomOut()"></permanence-map>
    </div>
  </div>
  <switch-map-list
    #switchMapList
    (switchMapList)="onDisplayMap($event)"
    [displayDetailsStructureId]="displayDetailsStructureId"></switch-map-list>
  <incomplete-data-notice
    [displayDetailsStructureId]="displayDetailsStructureId"
    [displayMap]="displayMap"></incomplete-data-notice>
</div>
